name: mdb-tools
prefect-version: 3.1.15

pull:
- prefect.deployments.steps.git_clone:
    id: clone-step
    branch: cloud-one-dev
    repository: https://github.com/nelsonwmoore/bento-mdb-updates.git   # will change to CBIIT/bento-mdb
- prefect.deployments.steps.run_shell_script:
    id: install-dependencies
    # note: cd into <repo name>-<branch name> below
    script: sh -c "cd bento-mdb-updates-cloud-one-dev && uv pip install --system . && uv sync
      --frozen"
- prefect.deployments.steps.run_shell_script:
    id: install-aws-cli
    script: sh -c "apt-get update && apt-get install -y --no-install-recommends curl unzip && cd /tmp && curl 'https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip' -o 'awscliv2.zip' && unzip awscliv2.zip && ./aws/install --update && curl 'https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb' -o 'session-manager-plugin.deb' && dpkg -i session-manager-plugin.deb && apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/awscliv2.zip /tmp/aws/ /tmp/session-manager-plugin.deb"
work_pool:
  name: mdb-docker-pool
  job_variables: prefect-worker:latest
  image_pull_policy: Never
deployments:
  - name: run-cypher
    version:
    tags: []
    concurrency_limit:
    description: Run arbitrary queries on MDB
    entrypoint: scripts/run_cypher.py:run_cypher_flow
    parameters: {}
    work_pool:
      name: fnl-mdb-8gb-prefect-2.20.3-python3.9
      work_queue_name:
      job_variables: {}
